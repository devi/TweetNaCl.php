<?php

require "../TweetNaCl.php";

function printDiff($a, $b) {
	printf("want: ");
		for ($i = 0; $i < 32; $i++) printf("%02x,", $a[$i]); printf("\n");
	printf("got : ");
		for ($i = 0; $i < 32; $i++) printf("%02x,", $b[$i]); printf("\n");
	printf("diff: ");
		for ($i = 0; $i < 32; $i++) {
			if ($a[$i] ^ $b[$i]) {
				printf("%02x,", $a[$i] ^ $b[$i]);
			} else {
				printf("  ,");
			}
		}
	printf("\n\n");
}

$alice_sk = array(
0xb1,0x99,0xe4,0x32,0xeb,0x45,0x59,0x0e,
0xab,0x40,0x54,0x93,0x07,0x38,0xbc,0xbe,
0x34,0xd5,0xc6,0x94,0xa7,0xe7,0xc0,0x43,
0xae,0xa2,0xa9,0x80,0xa0,0x94,0x59,0x1c
);

$bob_sk = array(
0xd8,0xa3,0x26,0x17,0x8d,0x98,0xcd,0xa5,
0x9f,0xff,0x28,0x1f,0x04,0x35,0x7c,0xbc,
0xe7,0x3c,0x98,0xdc,0x53,0x62,0x01,0x5f,
0x5a,0x8d,0x81,0x1a,0x73,0x24,0xac,0x6d
);

$expected = array(
0x2d,0x56,0xa3,0xd7,0xeb,0xb9,0xd6,0x06,
0x57,0xfe,0xf0,0xf5,0xc6,0x55,0x9a,0x68,
0xe8,0x3a,0x49,0x67,0x26,0x98,0x44,0x80,
0x41,0x8c,0xf6,0x86,0x7a,0xfb,0x74,0x63
);

$alice_pk = new SplFixedArray(32);
$bob_pk = new SplFixedArray(32);
$alice_shared = new SplFixedArray(32);
$bob_shared= new SplFixedArray(32);

$tweet = new TweetNaCl();

$time = -microtime(true);

$tweet->crypto_scalarmult_base($alice_pk, $alice_sk);
$tweet->crypto_scalarmult_base($bob_pk, $bob_sk);
$tweet->crypto_scalarmult($alice_shared, $alice_sk, $bob_pk);
$tweet->crypto_scalarmult($bob_shared, $bob_sk, $alice_pk);

if ($alice_shared->toArray() !== $expected) printDiff($expected, $alice_shared);
if ($bob_shared->toArray() !== $expected) printDiff($expected, $bob_shared);

$time += microtime(true);

printf("microtime: %f\n", $time);
printf("memory peak: %s\n", memory_get_peak_usage(true));
